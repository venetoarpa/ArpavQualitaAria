/*! App ARPAV Aria - v1.0.0 - 2013-09-07
* arpa.veneto.it
* Copyright (c) 2013 Daniele Lain - <daniele_lain@libero.it>;
	This program is free software: you can redistribute it and/or modify 
	it under the terms of the GNU General Public License as published by 
	the Free Software Foundation, either version 3 of the License, or 
	(at your option) any later version. 
 
	This program is distributed in the hope that it will be useful, 
	but WITHOUT ANY WARRANTY; without even the implied warranty of 
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
	GNU General Public License for more details. 
  
	You should have received a copy of the GNU General Public License 
	along with this program.  If not, see <http://www.gnu.org/licenses/>. */
var CentralinaItem=Backbone.Marionette.ItemView.extend({template:"#statlistel",tagName:"li",events:{"click .statlist_elem":"statdetails"},statdetails:function(){AA.router.navigate("station/"+this.model.get("codseqst"),{trigger:!0})}}),ProvinciaItem=Backbone.Marionette.ItemView.extend({template:"#provlistel",tagName:"li",events:{"click .statlist_elem":"provincia"},provincia:function(){AA.router.navigate("stations/"+this.model.get("nome"),{trigger:!0})}}),CentralinaAlertView=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change",this.render),0!==this.model.get("mis_o3").length&&this.model.set("ozonoStarred",AA.settings.isStationStarred(this.model.get("codseqst")))},events:{"click .toggle-ozone:not(.disabled)":"toggle_ozone"},toggle_ozone:function(){AA.settings.toggleStationAlert(this.model.get("codseqst")),this.model.set("ozonoStarred",AA.settings.isStationStarred(this.model.get("codseqst")))},template:"#toggle-ozone",render:function(){return $("#ozono-starred").html(_.template($(this.template).html(),this.model.attributes)),this}}),CentralinaPopupMap=Backbone.Marionette.ItemView.extend({template:"#statlistel",events:{"click .statlist_elem":"statdetails"},statdetails:function(){AA.router.navigate("station/"+this.model.get("codseqst"),{trigger:!0})}}),CentralinaView=Backbone.Marionette.ItemView.extend({initialize:function(){var a=AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Dati");if(a.on("cop",this.cop,this),0!==this.model.get("mis_o3").length){var b=this.model.get("mis_o3").max(function(a){return parseFloat(a.get("sample"))});this.model.set("maxo3",b)}if(0!==this.model.get("mis_pm10").length){var c=this.model.get("mis_pm10").max(function(a){return parseFloat(a.get("sample"))});this.model.set("maxpm10",c)}this.model.set("ozonoStarred",AA.settings.isStationStarred(this.model.get("codseqst")))},events:{"click .toggle-ozone:not(.disabled)":"toggle_ozone","click .cop":"cop"},toggle_ozone:function(){AA.settings.toggleStationAlert(this.model.get("codseqst")),this.model.set("ozonoStarred",AA.settings.isStationStarred(this.model.get("codseqst")))},cop:function(){AA.router.navigate("cop/"+this.model.get("provincia")+"/"+this.model.get("codseqst"),{trigger:!0})},template:"#details",tagName:"div",getStartDate:function(a){var b=_.first(a).get("date");return Date.parse(b.replace(/ /,"T"))},getValues:function(a){var b=[];return _.each(a,function(a){""!==a.get("sample")&&"NaN"!==a.get("sample")?b.push(parseFloat(a.get("sample"))):b.push(null)}),b},plotOzono:function(){0!==this.model.get("mis_o3").length&&($("html").hasClass("svg")?this.ozonoHighcharts():this.ozonoChart())},ozonoHighcharts:function(){$("#ozono-canvas").remove();var a=this.getStartDate(this.model.get("mis_o3").models),b=this.getValues(this.model.get("mis_o3").models);$("#ozono-hc").highcharts({chart:{type:"line"},colors:["#0d233a","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a"],xAxis:{type:"datetime",minTickInterval:432e5,dateTimeLabelFormats:{millisecond:"%e/%m/%Y, %H:%M:%S.%L",second:"%e/%m/%Y, %H:%M:%S",minute:"%e/%m/%Y, %H:00",hour:"%e/%m/%Y, %H:00",day:"%e/%m/%Y",week:"Week from %A, %b %e, %Y",month:"%m %Y",year:"%Y"}},yAxis:{min:0,max:320,tickInterval:40,title:{text:"µg/m3"},plotBands:[{from:0,to:120,color:"#BFFFFF"},{from:120,to:180,color:"#99FFFF"},{from:180,to:240,color:"#66D9FF"},{from:240,to:300,color:"#00B3FF"}],gridLineWidth:0},tooltip:{shared:!0,valueSuffix:" µg/m3",dateTimeLabelFormats:{millisecond:"%e/%m/%Y, %H:%M:%S.%L",second:"%e/%m/%Y, %H:%M:%S",minute:"%e/%m/%Y, %H:00",hour:"%e/%m/%Y, %H:00",day:"%e/%m/%Y",week:"Week from %A, %b %e, %Y",month:"%m %Y",year:"%Y"}},credits:{enabled:!1},title:{text:null},legend:{enabled:!1},plotOptions:{line:{pointStart:a,pointInterval:36e5}},series:[{name:"Ozono",data:b}]})},ozonoChart:function(){for(var a=this.getStartDate(this.model.get("mis_o3").models),b=[],c=a,d=Date.now(),e=0,f=0;d>=c&&48>e;){var g=new Date(c),h=g.getDate();h!=f||"12"==g.getHours()?(b.push(g.getDate()+"/"+(parseInt(g.getMonth(),null)+1)+" "+g.getHours()+":"+g.getMinutes()),f=h):b.push(""),c+=36e5,e+=1}var i=this.getValues(this.model.get("mis_o3").models);$("#ozono-canvas").get(0).width=$(document).width();var j=$("#ozono-canvas").get(0).getContext("2d");new Chart(j).Line({labels:b,datasets:[{fillColor:"rgba(220,220,220,0.0)",strokeColor:"rgba(13,35,58,1)",pointColor:"rgba(33,55,78,1)",pointStrokeColor:"#fff",data:i}]},{bezierCurve:!1,scaleShowLabels:!0,scaleOverride:!0,scaleSteps:8,scaleStepWidth:40,scaleStartValue:0})},plotPM10:function(){0!==this.model.get("mis_pm10").length&&($("html").hasClass("svg")?this.PM10Highcharts():this.PM10Chart())},PM10Highcharts:function(){$("#pm10-canvas").remove();var a=this.getStartDate(this.model.get("mis_pm10").models),b=this.getValues(this.model.get("mis_pm10").models);$("#pm10-hc").highcharts({chart:{type:"column"},colors:["#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a"],xAxis:{type:"datetime",minTickInterval:864e5,dateTimeLabelFormats:{millisecond:"%e/%m/%Y, %H:%M:%S.%L",second:"%e/%m/%Y, %H:%M:%S",minute:"%e/%m/%Y, %H:00",hour:"%e/%m/%Y, %H:00",day:"%e/%m/%Y",week:"Week from %A, %b %e, %Y",month:"%m %Y",year:"%Y"}},yAxis:{min:0,max:250,tickInterval:25,title:{text:"µg/m3"},plotBands:[{from:0,to:50,color:"#99FFFF"},{from:50,to:100,color:"#66D9FF"},{from:100,to:250,color:"#00B3FF"}],gridLineWidth:0},tooltip:{shared:!0,valueSuffix:" µg/m3",dateTimeLabelFormats:{millisecond:"%e/%m/%Y, %H:%M:%S.%L",second:"%e/%m/%Y, %H:%M:%S",minute:"%e/%m/%Y, %H:00",hour:"%e/%m/%Y, %H:00",day:"%e/%m/%Y",week:"Week from %A, %b %e, %Y",month:"%e %Y",year:"%Y"}},credits:{enabled:!1},title:{text:null},legend:{enabled:!1},plotOptions:{column:{pointPadding:0,borderWidth:0,pointStart:a,pointInterval:864e5}},series:[{name:"PM10",data:b}]})},PM10Chart:function(){for(var a=this.getStartDate(this.model.get("mis_pm10").models),b=[],c=a,d=Date.now(),e=0;d>=c&&7>e;){var f=new Date(c);f.getDate(),$(document).width()<300?1==e%2&&b.push(f.getDate()+"/"+(parseInt(f.getMonth(),null)+1)):b.push(f.getDate()+"/"+(parseInt(f.getMonth(),null)+1)),c+=864e5,e+=1}var g=this.getValues(this.model.get("mis_o3").models);$("#pm10-canvas").get(0).width=$(document).width();var h=$("#pm10-canvas").get(0).getContext("2d");new Chart(h).Bar({labels:b,datasets:[{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",data:g}]},{scaleShowLabels:!0,scaleOverride:!0,scaleSteps:5,scaleStepWidth:50,scaleStartValue:0})}}),CentralineList=Backbone.Marionette.CompositeView.extend({itemView:CentralinaItem,itemViewContainer:"ul#centraline",template:"#statlist",initialize:function(){AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Stazioni")}}),CopView=Backbone.Marionette.ItemView.extend({initialize:function(){AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Dati validati")},template:"#coptable",tagName:"div"}),MainView=Backbone.Marionette.ItemView.extend({initialize:function(){AA.controller.printHead(null,"Qualità Aria",null,1),this.listenTo(AA.geoHelper,"change",this.render)},template:"#main_test",events:{"click #maplink":"map","click #listlink":"list","click #settingslink":"settings","click #closestOzone":"closestOzone","click #closestPM10":"closestPM10"},map:function(){AA.router.navigate("map",{trigger:!0})},list:function(){AA.router.navigate("list",{trigger:!0})},settings:function(){AA.router.navigate("settings",{trigger:!0})},closestOzone:function(){AA.router.navigate("station/"+this.model.get("closestOzoneCod"),{trigger:!0})},closestPM10:function(){AA.router.navigate("station/"+this.model.get("closestPM10Cod"),{trigger:!0})}}),MapView=Backbone.Marionette.ItemView.extend({initialize:function(){this.listenTo(AA.geoHelper,"change",AA.controller.userMarker),AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Mappa",{show:1,icon:"icon-screenshot",id:"top_geoloc_map",text:"Mia pos."})},template:"#map-tpl"}),ProvinceList=Backbone.Marionette.CompositeView.extend({itemView:ProvinciaItem,itemViewContainer:"ul#centraline",template:"#statlist",initialize:function(){AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Province")}}),SettingsView=Backbone.Marionette.ItemView.extend({template:"#opts-tpl",initialize:function(){this.listenTo(this.model,"change",this.render),AA.controller.printHead({show:1,icon:"icon-chevron-left",id:"top_back",text:"Indietro"},"Preferiti")},events:{"click #ozone_activate:not(.disabled)":"ozone_on","click #ozone_deactivate:not(.disabled)":"ozone_off","click .centralina":"centralina","click .unsubscribe":"unsubscribe"},ozone_on:function(){AA.settings.setAlertActive(1)},ozone_off:function(){AA.settings.setAlertActive(0)},centralina:function(a){var b=$(a.currentTarget).attr("id");AA.router.navigate("station/"+b,{trigger:!0})},unsubscribe:function(a){a.stopImmediatePropagation();var b=$(a.currentTarget).closest("a").attr("id");AA.settings.toggleStationAlert(b)}}),TopView=Backbone.Marionette.ItemView.extend({template:"#top_page",events:{"click #top_back":"back","click #top_geoloc_map":"geoloc_map","click #top_cop":"cop"},back:function(){window.history.back()},geoloc_map:function(){AA.geoHelper.geoLocalize()},cop:function(){this.trigger("cop")}});