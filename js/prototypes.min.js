/*! App ARPAV Aria - v1.0.0 - 2013-09-07
* arpa.veneto.it
* Copyright (c) 2013 Daniele Lain - <daniele_lain@libero.it>;
	This program is free software: you can redistribute it and/or modify 
	it under the terms of the GNU General Public License as published by 
	the Free Software Foundation, either version 3 of the License, or 
	(at your option) any later version. 
 
	This program is distributed in the hope that it will be useful, 
	but WITHOUT ANY WARRANTY; without even the implied warranty of 
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
	GNU General Public License for more details. 
  
	You should have received a copy of the GNU General Public License 
	along with this program.  If not, see <http://www.gnu.org/licenses/>. */
var Airdata=Backbone.Collection.extend({model:Centralina}),Centralina=Backbone.Model.extend({defaults:function(){return{codseqst:"",nome:"",statcd:"",netcd:"",localita:"",citta:"",provincia:"",tipologia:"",lat:0,lon:0,mis_o3:new Misure,mis_pm10:new Misure,copdata:null,nodata:1}},formatTipologia:function(){switch(this.get("tipologia")){case"TU":return"stazione di Traffico situata in zona Urbana";case"BU":return"stazione di Background situata in zona Urbana";case"BS":return"stazione di Background situata in zona Suburbana";case"BRU":return"stazione di Background situata in zona Rurale";case"IU":return"stazione Industriale situata in zona Urbana";case"IS":return"stazione Industriale situata in zona Suburbana";default:return this.get("tipologia")}}}),CopTable=Backbone.Model.extend({defaults:function(){return{conc_no2:"",ora_no2:"",sup_no2:"",conc_pm10:"",sup_pm10:"",conc_o3:"",ora_o3:"",conc_mm_o3:"",sup_mm_o3:"",conc_so2:"",ora_so2:"",sup_so2:"",conc_mm_co:"",sup_mm_co:"",data:"",data_rif:"",nome:""}}}),GeoHelper=Backbone.Model.extend({defaults:function(){return{venetoSOlat:44.89,venetoSOlon:10.62,venetoNElat:46.68,venetoNElon:13.23,lat:45.45,lon:11.55,isGeoLocalized:0,closestOzone:0,closestOzoneName:"",closestOzoneCod:"",closestOzoneDist:0,closestOzoneDate:"",closestPM10:0,closestPM10Name:"",closestPM10Cod:"",closestPM10Dist:0,closestPM10Date:""}},initialize:function(){this.listenTo(AA.dataParser,"coordsReady",this.closestOzone),this.listenTo(AA.dataParser,"coordsReady",this.closestPM10)},geoLocalize:function(){navigator.geolocation.getCurrentPosition(function(a){AA.geoHelper.set("isGeoLocalized",1),AA.geoHelper.set("lat",a.coords.latitude),AA.geoHelper.set("lon",a.coords.longitude),AA.geoHelper.closestOzone(),AA.geoHelper.closestPM10(),AA.controller.userMarker()},function(a){console.log(a)}),navigator.geolocation.getCurrentPosition(function(a){AA.geoHelper.set("isGeoLocalized",1),AA.geoHelper.set("lat",a.coords.latitude),AA.geoHelper.set("lon",a.coords.longitude),AA.geoHelper.closestOzone(),AA.geoHelper.closestPM10(),AA.controller.userMarker()},function(a){console.log(a)},{enableHighAccuracy:!0})},closestOzone:function(){if(1===AA.geoHelper.get("isGeoLocalized")){var a=Number.MAX_VALUE,b=new L.LatLng(AA.geoHelper.get("lat"),AA.geoHelper.get("lon"));_(AA.airdata.filter(function(a){return 0!==a.get("mis_o3").length})).each(function(c){if(0!==c.get("lat")&&0!==c.get("lon")){var d=b.distanceTo(new L.LatLng(c.get("lat"),c.get("lon")));if(a>d){a=d,AA.geoHelper.set("closestOzone",c.get("mis_o3").last().get("sample")),AA.geoHelper.set("closestOzoneName",c.get("nome")),AA.geoHelper.set("closestOzoneCod",c.get("codseqst")),AA.geoHelper.set("closestOzoneDist",d);var e=new Date(c.get("mis_o3").last().get("date").replace(/ /,"T")),f=e.getDate()+"/"+(parseInt(e.getMonth(),null)+1)+"/"+e.getFullYear()+" "+e.getHours()+":00";AA.geoHelper.set("closestOzoneDate",f)}}})}},closestPM10:function(){if(1===AA.geoHelper.get("isGeoLocalized")){var a=Number.MAX_VALUE,b=new L.LatLng(AA.geoHelper.get("lat"),AA.geoHelper.get("lon"));_(AA.airdata.filter(function(a){return 0!==a.get("mis_pm10").length})).each(function(c){if(0!==c.get("lat")&&0!==c.get("lon")){var d=b.distanceTo(new L.LatLng(c.get("lat"),c.get("lon")));if(a>d){a=d,AA.geoHelper.set("closestPM10",c.get("mis_pm10").last().get("sample")),AA.geoHelper.set("closestPM10Name",c.get("nome")),AA.geoHelper.set("closestPM10Cod",c.get("codseqst")),AA.geoHelper.set("closestPM10Dist",d);var e=new Date(c.get("mis_pm10").last().get("date").replace(/ /,"T")),f=e.getDate()+"/"+(parseInt(e.getMonth(),null)+1)+"/"+e.getFullYear();AA.geoHelper.set("closestPM10Date",f)}}})}}}),MapHelper=Backbone.Model.extend({defaults:function(){return{userMarker:null}},setupMap:function(a,b,c,d){var e;$("#map").height($(window).height()-$("#topnav").height()+"px"),e=new L.Map("map",{maxBounds:new L.LatLngBounds(new L.LatLng(a,b),new L.LatLng(c,d))});var f="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",g="Map data Â© OpenStreetMap contributors",h=new L.TileLayer(f,{minZoom:8,maxZoom:15,attribution:g});e.addLayer(h),AA.map=e},setView:function(a,b){AA.map.setView(new L.LatLng(a,b),10)},stdMarker:function(a,b,c){var d=L.marker([a,b]).addTo(AA.map);null!==c&&d.bindPopup(c)},userMarker:function(a,b){var c=this.get("userMarker");if(null===c){var d=L.icon({iconUrl:L.Icon.Default.imagePath+"/my_marker.png",iconRetinaUrl:L.Icon.Default.imagePath+"/my_marker-2x.png",iconSize:[25,26]});c=L.marker([a,b],{icon:d,clickable:!1}),c.addTo(AA.map),this.set("userMarker",c)}else c.setLatLng(new L.LatLng(a,b));AA.map.panTo(new L.LatLng(a,b))}}),Misurazione=Backbone.Model.extend({defaults:function(){return{date:"",sample:"0"}}}),Misure=Backbone.Collection.extend({model:Misurazione}),ModalHelper=Backbone.Model.extend({defaults:function(){return{currentDialog:null}},showLoading:function(){$("#loadingmodal").modal("show")},hideLoading:function(){$("#loadingmodal").modal("hide")},showError:function(a){"undefined"==typeof a||0===a?$("#errormodal").modal("show"):$("#errormodalclose").modal("show")}}),O3=Misurazione.extend({sample_date:function(){var a=this.get("date");return a.substr(0,12)}}),Page=Backbone.Model.extend({defaults:function(){return{left_show:0,left_href:"",left_text:"",center:"",right_show:0,right_href:"",right_text:"",top_show:0}}}),PM10=Misurazione.extend({sample_date:function(){var a=this.get("date");return a.substr(0,10)}}),Province=Backbone.Collection.extend({model:Provincia}),Provincia=Backbone.Model.extend({defaults:function(){return{nome:""}}}),Settings=Backbone.Model.extend({defaults:function(){return{alert_status:this.isAlertActive(),saved_stations:this.getSavedStations()}},isAlertActive:function(){var a=AA.storage.getItem("ozone_alert");return null===a?(AA.storage.setItem("ozone_alert",0),0):a},setAlertActive:function(a){return AA.storage.setItem("ozone_alert",a),AA.settings.set("alert_status",a),a},getSavedStations:function(){return JSON.parse(AA.storage.getItem("saved_stations"))},isStationStarred:function(a){var b=0;return _.each(AA.settings.getSavedStations(),function(c){c==a&&(b=1)}),b},toggleStationAlert:function(a){AA.settings.setAlertActive(1);var b=AA.settings.getSavedStations();Array.isArray(b)||(b=[]);var c=b.indexOf(a);-1===c?b.push(a):b.splice(c,1),AA.storage.setItem("saved_stations",JSON.stringify(b)),AA.settings.set("saved_stations",b)}});